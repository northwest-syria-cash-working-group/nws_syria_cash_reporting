---
title: "Northwest Syria Cash Working Group report on multipurpose cash"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_download: yes
    theme: readable
    toc: yes
    toc_depth: 4
    toc_float: yes
    number_sections: no
    collapsed: no
always_allow_html: yes
---

```{css, echo=FALSE}

#TOC::before {
  content: "";
  display: block;
  height: 70px;
  margin: 2em 20px 40px 20px;
  background-image: url("NWS-CWG logo.PNG");
  background-size: contain;
  background-position: center center;
  background-repeat: no-repeat;
}
```

```{=html}
<style>
    body .main-container {
        max-width: 1280px;
    }
</style>
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.width=9, message = FALSE, warning=FALSE)
library(tidyverse)
library(readxl)
library(lubridate)
library(stringi)
library(pander)
library(janitor)
library(scales)
library(magrittr)
library(viridis)
library(patchwork)
library(DT)
library(sf)
library(plotly)
library(flextable)
library(ggrastr)
library(htmlwidgets)

theme_set(theme_light())

# disabling scientific notation
options(scipen = 100)

# pander tables all in one row
panderOptions('table.split.table', Inf)

# pander thousands separator
panderOptions("big.mark", ",")

# replace 
opts <- options(knitr.kable.NA = "")

`%out%` <- Negate(`%in%`)

# function for transposing df
transpose_df <- function(df) {
  t_df <- data.table::transpose(df)
  colnames(t_df) <- rownames(df)
  rownames(t_df) <- colnames(df)
  t_df <- t_df %>%
    tibble::rownames_to_column(.data = .) %>%
    tibble::as_tibble(.)
  return(t_df)
}

# function beneficiary summaries
sum_ben <- function(df, column_var){
  
  column_var <- enquo(column_var)
  
  df %>%
    group_by(!!column_var) %>% # must add bang-bang
    summarise(beneficiaries = sum(new_beneficiaries, na.rm = TRUE)) %>% 
    arrange(desc(beneficiaries))
    
}

# function beneficiary summaries, 2 grouped variables
sum_ben2 <- function(df, column_var1, column_var2){
  
  column_var1 <- enquo(column_var1)
  column_var2 <- enquo(column_var2)
  
  df %>%
    group_by(!!column_var1, !!column_var2) %>% # must add bang-bang
    summarise(beneficiaries = sum(new_beneficiaries, na.rm = TRUE), .groups = "drop")
    
}

# scaling functions 
range01 <- function(x){(x-min(x))/(max(x)-min(x))}
range_wna <- function(x){(x-min(x, na.rm = TRUE))/(max(x, na.rm = TRUE)-min(x, na.rm = TRUE))}

#mode function 
mode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}


knitr::opts_chunk$set(dev="png")
```

```{r data}
pcode3_shape <- 
  st_read("./data/syr_admbnda_uncs_unocha_20201217/syr_admbnda_adm3_uncs_unocha_20201217.shp", 
          quiet = TRUE)

locations <- read_excel("./data/Locations.xlsx") %>% 
  clean_names()

fsl <- read_csv("./data/for_report/fsl.csv") %>% 
  mutate(partner_code = ifelse(is.na(partner_code), "temp_1", partner_code))

sites <- read_csv("./data/for_report/sites.csv")

remove_sites <- read_csv("./data/for_report/sites_locations_fsl.csv") %>%
  filter(!is.na(longitude_x) & !is.na(latitude_y)) %>% 
  st_as_sf(coords = c("longitude_x", "latitude_y"), crs = 4326) %>%
  st_transform(st_crs(pcode3_shape)) %>% 
  mutate(intersection = as.integer(st_intersects(geometry, pcode3_shape)), 
         area = ifelse(is.na(intersection), "", pcode3_shape$ADM3_PCODE[intersection])) %>%
  filter(is.na(intersection)) 

sites_locations_fsl <- read_csv("./data/for_report/sites_locations_fsl.csv") %>% 
  anti_join(remove_sites, by = c("site_name"))



```  

<br><br><br>

# 1 Summary of achievements to-date 

```{r summary table}
fsl %>% 
  filter(activity == "Cash Response" & planned_implemented == "Implemented") %>%
  mutate(usd_total = families * quantity) %>% 
  group_by(governorate, district) %>% 
  summarise(partners = n_distinct(partner_code), 
            communities = n_distinct(admin4pcode), 
            households = sum(families, na.rm = TRUE), 
            beneficiaries = sum(beneficiaries, na.rm = TRUE), 
            total_usd = sum(usd_total, na.rm = TRUE)) %>% 
  ungroup() %>% 
  mutate(`%_beneficiaries` = 
           round(beneficiaries / sum(beneficiaries, na.rm = TRUE) * 100, digits = 2)) %>%
  adorn_totals("row",,,, households, beneficiaries, total_usd, `%_beneficiaries`) %>% 
  mutate(`%_beneficiaries` = ifelse(`%_beneficiaries` > 99.98, 100, `%_beneficiaries`)) %>% 
  flextable() %>% 
  set_caption("308,467 people reached, USD 9.4 million disbursed, 20230317") %>% 
  theme_zebra()
  
  
```

<br><br><br>

# 2. Map of MPC beneficiaries and collective/reception centres

As of `r format(Sys.time(), "%B %d %Y")`, a total of `r fsl %>% filter(activity == "Cash Response" & planned_implemented == "Implemented") %>% {sum(.$beneficiaries)} %>% format(big.mark = ",")` persons or `r fsl %>% filter(activity == "Cash Response" & planned_implemented == "Implemented") %>% {sum(.$families)} %>% format(big.mark = ",")` families have been reached by MPC interventions. 

A total of USD `r fsl %>% filter(activity == "Cash Response" & planned_implemented == "Implemented") %>% mutate(usd_total = families * quantity) %>%  {sum(.$usd_total)} %>% format(big.mark = ",")` has been disbursed by `r fsl %>% filter(activity == "Cash Response" & planned_implemented == "Implemented") %>% summarise(n_distinct(partner_code)) %>% pull()` implementing agencies across `r fsl %>% filter(activity == "Cash Response" & planned_implemented == "Implemented") %>% summarise(n_distinct(admin3pcode)) %>% pull()` sub-districts. 

Only beneficiaries who have received at least USD 100/family/month have been included. Additionally, current achievement reporting has yet to include the collective sites, only information on communities, so it is not clear to what extent needs have been met in these centres. This will be corrected in revised 4W template. 


<br>


```{r plotly-sites}

site_map <- sites_locations_fsl %>% 
  left_join(locations %>% select(admin3pcode, admin4pcode), 
            by = "admin4pcode") %>%
  right_join(pcode3_shape, 
             by = c("admin3pcode" = "ADM3_PCODE")) %>% 
  filter(ADM1_PCODE %in% c("SY02", "SY07")) %>% 
  st_as_sf() %>% 
  mutate(type = fct_relevel(type, 
                            c("RC/IDP", "Beneficiaries"))) %>% 
  ggplot() + 
  geom_sf(size = 0.1, colour = "grey70") +
  geom_point(aes(size = persons, 
                  colour = type,
                  x = longitude_x, y = latitude_y,
                  text = paste0("sub_district: ", sub_district, "\n",
                                "site: ", site_name, "\n",  
                                "persons: ", persons, "\n", 
                                "type: ", type, "\n", 
                                "lon_x: ", longitude_x, "\n", 
                                "lat_y: ", latitude_y)), 
             shape = 21, stroke = .5
             # Adjusting alpha won't affect a plotly
             ) +
  scale_size_continuous(labels = comma) +
  theme_void() + 
  theme(plot.background = element_rect(fill = "white", colour = NA), 
        plot.caption = element_text(hjust = 0.5), 
        legend.position = "none") +
  labs(title = "Collective/reception centres and MPC beneficiaries", 
       subtitle = "IDPs in red, beneficiaries in blue, size shows number of persons")

ggplotly(site_map, tooltip = c("text")) %>% 
  plotly::style(hoveron = "point") %>% 
  layout(title = list(text = paste0("Collective centres and cash response beneficiaries", 
                                    "<br>", 
                                    "<sup>", 
                                    "IDPs in red, beneficiaries in blue, size shows number of persons; click and drag to zoom; mouse over for details"))) 

# Will this work? 
# %>% partial_bundle()
```


Data on cash response extracted from [FSL earthquake tracker](https://docs.google.com/spreadsheets/d/1KGqt-3YDh2k8qNCksOJAndRPO56Gq6pGs6esEQtIFIw/edit#gid=1890981115) on `r format(Sys.time(), "%B %d %Y")`. Data on collective centres extracted from March 15 2023. 

<br><br>


### 2.1 Geographic breakdown of beneficiaries

```{r}
fsl %>% 
  filter(activity == "Cash Response" & planned_implemented == "Implemented") %>% 
  mutate(governorate = ifelse(governorate == "idleb", "Idleb", governorate),
         district = ifelse(district == "idleb", "Idleb", district)) %>% 
  group_by(governorate, district) %>% 
  summarise(beneficiaries = sum(beneficiaries, na.rm = TRUE)) %>% 
  mutate(district = fct_reorder(district, beneficiaries), 
         governorate = fct_relevel(governorate, 
                                   c("Idlib", "Aleppo"))) %>% 
  ggplot(aes(x = beneficiaries, y = district)) + 
  geom_col(aes(fill = governorate)) + 
  geom_text(aes(label = comma(beneficiaries)), 
            hjust = "inward") + 
  scale_fill_viridis_d(begin = .3) + 
  labs(title = "MPC beneficiaries by district", 
       subtitle = "as of 15 March 2023") + 
  scale_x_continuous(labels = comma)
```

<br><br>

### 2.2 UNHCR site tracker -- searchable table

```{r dt}
sites %>% 
  select(governorate, 
         district, 
         sub_district, 
         community, 
         site_name, 
         longitude_x,
         latitude_y, 
         families, 
         individuals, 
         focal_point = organization_name, 
         focal_contact = phone) %>% 
  datatable(options = list(pageLength = 10, scrollX = TRUE), 
            filter = list(position = "top", clear = FALSE),
            caption = htmltools::tags$caption(style = 'caption-side: top; 
                                    text-align: center; font-size:120% ;',
                                    "Reference table -- Collective sites, maintained by UNHCR")) %>% 
  formatStyle(0, target = "row", lineHeight = "80%", fontSize = "80%")
  
```


<br><br><br>


# 3. Cash response actors

In the scatterplot below, each point is a single cash working group partner. The x-axis indicates the number of beneficiaries reached per agency and the y-axis indicates the number of communities (admin4) reached. 

From the scatterplot, we may split partners into two groups -- those with below 10,000 beneficiaries and those with more 

```{r totals, eval = FALSE}

fsl %>% 
  filter(activity == "Cash Response" & planned_implemented == "Implemented") %>% 
  mutate(usd_total = families * quantity) %>% 
  summarise(beneficiaries = sum(beneficiaries, na.rm = TRUE), 
            usd_total = sum(usd_total, na.rm = TRUE))

```


<br><br>

### 3.1 Beneficiaries and geographic reach

```{r partner-scatter}
partner_scatter <- fsl %>% 
   filter(activity == "Cash Response" & planned_implemented == "Implemented") %>% 
  group_by(partner_code, 
           admin2pcode, 
           admin4pcode) %>% 
  slice(which.max(beneficiaries)) %>% 
  ungroup() %>% 
  group_by(partner_code) %>% 
  summarise(beneficiaries = sum(beneficiaries, na.rm = TRUE), 
            communities = n_distinct(admin4pcode)) %>% 
  ggplot(aes(x = beneficiaries, y = communities)) +
  geom_point(aes(size = beneficiaries, 
                 text = paste0(partner_code, "\n", 
                               "beneficiaries: ", format(beneficiaries, big.mark = ","), "\n", 
                               "communities: ", communities))) + 
  scale_x_log10(labels = comma) + 
  theme(legend.position = "none") + 
  labs(x = "Beneficiaries reached", 
       y = "Communities (admin4) reached", 
       title = "Implementing partners -- beneficiaries and communities reached")

ggplotly(partner_scatter, tooltip = c("text")) %>% 
  layout(showlegend = TRUE, legend = list(font = (list(size = 6)))) %>% 
  plotly::style(hoveron = "point") %>% 
  layout(title = list(text = paste0("Beneficiaries and communities reached",
                                    "<br>",
                                    "<sup>",
                                    "Cash response implementing partners","</sup>")))


```

<br><br>

### 3.2 Reach and footprint of cash response actors

```{r}
stack_text <- fsl %>% 
  filter(activity == "Cash Response" & planned_implemented == "Implemented") %>% 
  group_by(district) %>% 
  summarise(total = sum(beneficiaries, na.rm = TRUE)) %>% 
  mutate(district = fct_relevel(district, 
                             c("Afrin", "Al Bab", "A'zaz", "Jarablus",
                               "Jebel Saman", "Harim", "Idleb", "Jisr-Ash-Shugur")))

stack <- fsl %>% 
  filter(activity == "Cash Response" & planned_implemented == "Implemented") %>% 
  group_by(district, partner_code) %>% 
  summarise(beneficiaries = sum(beneficiaries, na.rm = TRUE)) %>% 
  mutate(district = fct_relevel(district, 
                             c("Afrin", "Al Bab", "A'zaz", "Jarablus",
                               "Jebel Saman", "Harim", "Idleb", "Jisr-Ash-Shugur"))) %>% 
  ggplot(aes(x = district, 
             y = beneficiaries)) +
  geom_col(aes(fill = partner_code)) + 
  geom_text(data = stack_text, 
            aes(y = total + 6000, 
                label = scales::comma(total))) + 
  scale_y_continuous(labels = comma) + 
  labs(x = "", 
       y = "Beneficiaries", 
       title = "Partner achievements by district, 20230317") + 
  theme(legend.position = "none")

ggplotly(stack, tooltip = c("fill", "x", "y")) %>% 
  layout(title = list(text = paste0("Partner achievements by district, 20230317", 
                                    "<br>", 
                                    "<sup>", 
                                    "Mouse over for details")))

```

<br>

USD `r fsl %>% filter(activity == "Cash Response" & planned_implemented == "Implemented") %>% mutate(usd_total = families * quantity) %>% {sum(.$usd_total)} %>% format(big.mark = ",")` has been distributed across `r fsl %>% filter(activity == "Cash Response" & planned_implemented == "Implemented") %>% {n_distinct(.$admin4pcode)}` communities and `r fsl %>% filter(activity == "Cash Response" & planned_implemented == "Implemented") %>% {n_distinct(.$admin3pcode)}` sub-districts in NW Syria. 
<br>

```{r}
fsl %>% 
  filter(activity == "Cash Response" & planned_implemented == "Implemented") %>% 
  group_by(partner_code, 
           admin2pcode, 
           admin4pcode) %>% 
  slice(which.max(beneficiaries)) %>% 
  ungroup() %>% 
  group_by(partner_code) %>% 
  summarise(beneficiaries = sum(beneficiaries, na.rm = TRUE), 
            districts = n_distinct(admin2pcode), 
            communities = n_distinct(admin4pcode)) %>% 
  arrange(desc(beneficiaries)) %>% 
  flextable() %>% 
  set_caption("Reach and footprint of cash response actors") %>% 
  theme_zebra() %>% 
  set_table_properties(layout = "autofit", width = .8) %>% 
  footnote(as_paragraph("Only partners who provided more than USD 100/family/month"), 
           i = 1, j = 1, part = "header")
  
```



<br><br>




### 3.3 USD disbursed by partner


```{r}
fsl %>% 
  filter(activity == "Cash Response" & planned_implemented == "Implemented") %>% 
  mutate(usd_total = families * quantity) %>% 
  group_by(partner_code) %>% 
  summarise(usd_total = sum(usd_total, na.rm = TRUE), 
            families = sum(families, na.rm = TRUE)) %>% 
  mutate(usd_per_fam = round(usd_total / families, digits = 2), 
         `%_usd_total` = round(usd_total / sum(usd_total) * 100, 
                             digits = 2)) %>%
  arrange(desc(usd_total)) %>% 
  flextable() %>% 
  set_caption("USD disbursed and families reached by partner") %>% 
  theme_zebra() %>% 
  flextable::set_table_properties(layout = "autofit", width = .8)
```

<br>






